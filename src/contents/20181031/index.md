---
title: "Spring Fest 2018 参加レポート"
date: "2018-10-31T10:50:21"
category: "TechConference"
tags: ["Java", "Spring", "勉強会"]
---

# イベント概要

- 日時： 2018年10月31日 10:00 - 18:30
- 場所： 両国　KFCホール（チキンとは関係なかた）
- URL： http://springfest2018.springframework.jp/
- 主催：Spring日本ユーザ会。その他スポンサーは割とTech系とSIer系とIT教育系

# どんなイベントだった？

今回のイベントでのホットワードは以下の３つかなと個人的に感じた
- Micro Service
- Serverless
- Agile

個人的にはこの3つは切り離せない関係にあると思っている。
マイクロサービスを実現するには、小さいチームでも成り立つようにサーバレスで運用作業を軽減する。
マイクロサービスを実現するために、小さいチームのパフォーマンスをアジャイルで最大化する。

特にJava系のイベントということで、他の勉強会に比べて堅いというかレガシーというか、
そういったところに所属している参加者が多かった。
ただ、硬くレガシーな人も課題感はもっており、転換するためにどうするか？
という考えを持ってSpringに向き合いに来た感じはあった。

意外にKotlinに対する興味は皆持っているようだった。
自分も参加したが、Kotlinに関するセッションでは立ち見がかなり発生していた。
懇親会でも、Kotlinどう思う？みたいな話はちょくちょくあった。

後述しますが、Kotlin x SpringBoot2.0は試したことがあり、良い印象をもっている。
Kotlinはゆくゆく導入したいなーという考えがあるので、ちゃんとアンテナをはっておこうと思った。

最後に普通の感想として…

同じSI系の人と話ができたのが嬉しかった。
特に、SIの古さを感じて「どうにかしたい！」と思っている人と会話できたのが、
今回最大の収穫でした。

あと、FLUX、Reactiveに対する誤解が溶けたのも地味に良い収穫だった。笑

# Sessions
## エンタープライズ・マイクロサービスの格言
Agenda
> エンタープライズ系システムのマイクロサービス化、それが、エンタープライズ・マイクロサービス。 Spring Fest 2017の「日本一やさしいマイクロサービス入門」の続編的ハナシとして、エンタープライズ・マイクロサービスを上手くやるための格言などを噺します。 真面目なセッションで疲れてしまった貴方の頭が休まるセッション(!?)。

プロジェクトをスケールする手段として、マイクロサービス(MS)化を選んでいきたいなと思っているこの頃。
エンタープライズ向けマイクロサービスというタイトルに惹かれて参加。

一応、自分が担当しているプロジェクトはマイクロサービスといえるのかな…？と思う。

「オブジェクト指向がわからないのに、マイクロサービスに飛びついてもできる訳がない」という言葉には完全に同意。

自分も「マイクロサービスってなんですか？」って聞かれてたときに
プログラムでオブジェクト指向がベストプラクティスとされてますよね。
それをサービスレベルでオブジェクト指向していった結果がマイクロサービスだと思う。
といったりする。

### 企画編
エンタープライズ経過得意なSI企業はマイクロサービス・アーキテクチャでのシステム開発に向かない。
理由：開発の方法がレガシー。MSは試行錯誤が多いので、管理を重んじるSI企業ではスピード感で出ずにより難しくなっている。

MSの切り分けの単位は、最初は主観的な粒度で良い
必要があれば、徐々に粒度を細かくすれば良い。（大きくなってきたら、分割するみたいな考え方？）
その際に、ドメイン駆動設計(DDD)を取り入ればなお良い。

開発プロセスはアジャイルが良い。
基本的にMSは探索的な開発になるので、手戻りが難しいウォーターフォール(WF)型は難しいんじゃないかなというところ。
個人的にも、ちょっとした失敗・手戻りでも管理をしなきゃいけないWF型はMSに向かないと思ってる。

>
エンターブライズなシステム開発では、技術スキルの低さが問題となる。
優秀なチームリーダを配置することで最低限の品質をチームリーダで保証していく。

チーム単位では、技術レベルの高さは求められるのがMSなので、
これも１つの解決方法なのかなーと思ったりする。

### 開発編
共通処理はやめる。
業務ロジックなどの共通処理を作ってしまうと、サービス間で結合が生まれてしまう。
共通処理を作るくらいなら、別MSとして切り出せないか考えたほうが良い。

実際の開発では、共通処理を作るべきか否かは、その処理の大きさによるのかなと思った。
その損益分岐点の見極めはアーキテクトとしての腕の見せどころかな。

MSはテストをちゃんと作らなければならない。
MSの進化を短時間で行うためには、リグレッションを保証していくことが必要。
CI環境の重要性はWF型よりも大切になってくる。

UTの実行速度は大切。（プルリクでUT時間かかりすぎてマージできない問題）
`@SpringBootTest` は時間がかかりすぎる（不要にAPサーバを起動しない

マイクロサービスでは、トランザクションの難しさはある。
そもそも、トランザクションの難度を下げるような設計思想を持ったほうがいいと気持ちを改めた。

## 実際のプロジェクトでSpringアプリをKotlinで開発して得た気づき集
Speacker: https://taro.hatenablog.jp/
Agenda:
>
SpringはかねてよりKotlinをサポートしていましたが、Spring Framework 5.0でよりKotlinフレンドリなAPIを提供し始めました。本セッションでは、SpringアプリをKotlinで開発する基本的な話と、実際の開発を経験して得られた知見をTips集のような形で共有します。
本セッションを聴いていただき、Kotlinへの関心を高め、Kotlin x Springにありがちな落とし穴を回避する策を学んでいただければ幸いです。


### KotlinでSpringアプリを始める
`@Service` などがついたクラスはSpringによってサブクラスが生成される。
そのため、デフォルトでfinal classなKotlinは気をつけないといけない。
これでは開発しづらいので、kotlin-springプラグインを使用すると良い。
Kotlin-spingプラグインはSpring Anotationのついたクラスをallopenの対象として扱ってくれる。

Validationに注意。
`@NonNull` のようなものは `@field:Notnull`としてやる必要がある。
KotlinがJavaにコンパイルされたときの形を考える必要がまだ何箇所かである。

int? はInteger, intはint扱いになるので、注意しよう。

### WebFluxとコルーチン
リアクターなところを、コルーチンを使用すると可読性を上げることができる。
コルーチンってなんだ？＝ asyncとかawaitとかやつ？

JSでPromiseの可読性が悪くなるので、async, awaitを使ってあげましょう。
という話と似たものがありそう。

### アノテーションをやめる
アノテーションを削除する代わりに、自分でBean登録してやろうという話。

以下、サンプルコード
```kotlin{4-12}
SpringAppicationBuilder()
  .sources(DemoApplication::class.java)
  .initializers(beans {
      bean { DemoService() }
      bean { DemoController(ref()) } // DIは型推論によって解決してくれる
      bean {
        router {
          GET("/demo") {
            ref<DemoController>().helloWorld() // 型推論ができないものは自身で設定
          }
        }
      }
    })
  .run(*args)
```

アノテーションに馴染んでいるものからすると、あまりメリットを感じない。


### テスト！
Kotlinテスト周辺ツールは下記らしい。

- JUnit5
  - `@Nested`を使用した、メソッドグルーピングがわかりやすい。（Javaでも使用可能）
  - JUnit5になったことで、最近のプログラミング言語っぽく技術ができるようになってそうに見えた。
- AssertJ
- MockK
- DbSetup-kotlin

Kotlin 1.3から文脈からNotNullを推定してくれる機能がついた。
```kotlin
if(item != null) {
  item.name // 従来はitem?.nameという記述が必要だった。
}
```

MockitoでKotlinクラスをmockしようとして失敗したのは良い思い出。
`final`だったからできなかったのだが、MockKを使用すればmockできるそうな。


### 感想
Kotlin1.1 x SpringBoot2.0を2018年3月くらいに触ったことがあります。
当時は、ちょっと使いづらいなぁという部分がいくつかありました。
半年経ってKotlin1.3はだいぶ進化していて、PJで使えるようになってそうと感じた。

## Knative: Serving your Serverless Java Service on Kubernetes the 12-Factor way
- https://slidr.io/kameshsampath/knative-serving-your-serverless-services#1
- https://blog.openshift.com/knative-serving-your-serverless-services/
- https://blog.openshift.com/knative-building-your-serverless-service/
- https://blog.openshift.com/knative-configurations-routes-and-revisions/

Japanese Nativeには辛い英語セッションでした。

Knativeは強力そう。ということが分かったので帰ったら調べてみたいと思うところ。


## 基礎からのOAuth 2.0とSpring Security 5.1による実装
Agenda:
>
OAuth 2.0は、Web APIでよく利用される認可プロトコルです。Spring Securityでは、5.0でクライアント機能、5.1でリソースサーバー機能が追加されました。このセッションでは、前半でOAuth 2.0についてはじめから丁寧に解説します。そして後半では、Spring Security5.1のクライアント機能やリソースサーバー機能を、実装例を交えながら紹介します。認可サーバーはDocker + Keycloakで構築します）
OAuth2.0の名前を聞いたことはあるけど詳細は知らない・・・という方にピッタリのセッションです。

Spring Sercurity 5.0から、OAuth2.0を標準搭載。
以前はSpring Sercurity OAuth2等を使用していた。
Spring Sercurity 5はクライント・リソースサーバ側のみ対応。認可サーバは5.2以降から順次展開予定
（ただし、少しずつ認可機能が追加されるので、フル機能をもった認可はまだ先の話だそうな。

Spring Sercurity OAuthは分かりづらいという話があったが、ホントにそうだと思う。

実際、ドキュメント少なすぎて生のソースコードを読み解いて理解したのは良い思い出。
今回、SpringがOAuth機能を新たに作り直してSpring Security標準搭載させたのは英断だと思ってる。

近いうちに、Spring Security 5系を使って、クライアントサーバを試してみようかなと。

使用していたpackageたち。
```
spring-security-oauth-client
spring-security-oauth-resource
```


# Tips
- 技術評論社「間違いだらけのソフトウェア・アーキテクチャ」
- オライリー「effective devops」
